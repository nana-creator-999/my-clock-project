<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>管理者ページ（スマホ版）</title>
<link rel="stylesheet" href="style2.css">
<style>
  h1 {
    margin-top: 30px;
  }

  table {
    margin-top: 20px;
  }

  .deleteBtn {
    background: #d90429;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 0.9em;
  }

  .deleteBtn:hover {
    background: #9b0000;
  }

  .control-buttons {
    margin-top: 30px;
  }

  button {
    margin: 8px;
  }
</style>
</head>
<body class="data-page">
  <h1>管理者ページ（スマホ版）</h1>

  <table id="table">
    <tr><th>名前</th><th>生まれた時間</th><th>現在の自分時間</th><th>操作</th></tr>
  </table>

  <div class="control-buttons">
    <button onclick="clearData()">すべて削除</button>
    <button onclick="backupData()">バックアップ</button>
    <button onclick="restoreData()">復元</button>
    <button onclick="window.location.href='data2.html'">閲覧ページへ戻る</button>
  </div>

<script>
function loadData() {
  const people = JSON.parse(localStorage.getItem("peopleData") || "[]");
  const table = document.getElementById("table");

  // テーブル初期化（ヘッダーを残してクリア）
  while (table.rows.length > 1) {
    table.deleteRow(1);
  }

  people.forEach((p, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${p.name}</td>
      <td>${p.time}</td>
      <td id="time-${i}">--:--</td>
      <td><button class="deleteBtn" onclick="deletePerson(${i})">削除</button></td>
    `;
    table.appendChild(row);
  });

  updateAllClocks();
  setInterval(updateAllClocks, 10000);
}

function updateAllClocks() {
  const people = JSON.parse(localStorage.getItem("peopleData") || "[]");
  people.forEach((p, i) => {
    const timeCell = document.getElementById(`time-${i}`);
    if (!timeCell) return;

    const [bh, bm] = p.time.split(":").map(Number);
    const now = new Date();
    const birth = new Date();
    birth.setHours(bh, bm, 0, 0);
    if (now < birth) birth.setDate(birth.getDate() - 1);

    const diffMs = now - birth;
    const diffH = Math.floor(diffMs / (1000 * 60 * 60));
    const diffM = Math.floor((diffMs / (1000 * 60)) % 60);
    const modH = diffH % 24;

    timeCell.textContent = `${String(modH).padStart(2, "0")}:${String(diffM).padStart(2, "0")}`;
  });
}

function deletePerson(index) {
  if (!confirm("この人のデータを削除しますか？")) return;

  const people = JSON.parse(localStorage.getItem("peopleData") || "[]");
  people.splice(index, 1);
  localStorage.setItem("peopleData", JSON.stringify(people));
  loadData(); // 再描画
}

function clearData() {
  if (confirm("すべてのデータを削除しますか？")) {
    localStorage.removeItem("peopleData");
    alert("すべて削除しました");
    loadData();
  }
}

function backupData() {
  const data = localStorage.getItem("peopleData");
  if (!data) {
    alert("保存データがありません。");
    return;
  }

  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const now = new Date();
  const timestamp = now.toLocaleString('ja-JP').replace(/[/: ]/g, "_");
  a.href = url;
  a.download = `peopleData_backup_${timestamp}.json`;
  a.click();
  URL.revokeObjectURL(url);
  alert("バックアップを保存しました。");
}

function restoreData() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json";
  input.onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const json = JSON.parse(event.target.result);
        localStorage.setItem("peopleData", JSON.stringify(json));
        alert("復元が完了しました。");
        loadData();
      } catch {
        alert("復元に失敗しました。");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

loadData();
</script>
</body>
</html>